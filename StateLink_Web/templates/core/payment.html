{% extends 'base.html' %}

{% block title %}Payment - Business Compliance Organization LLC{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Payment</h2>
                </div>
                <div class="card-body">
                    <!-- Business Information -->
                    <div class="mb-4">
                        <h4>Business Information</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Business Name:</strong> {{ business.name }}</p>
                                <p><strong>Reference Number:</strong> {{ business.reference_number }}</p>
                                <p><strong>State:</strong> {{ business.state_code }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Business Type:</strong> {{ business.get_business_type_display }}</p>
                                <p><strong>Principal Address:</strong> {{ business.address }}{% if business.address2 %}, {{ business.address2 }}{% endif %}, {{ business.city }}, {{ business.state_code }} {{ business.zip_code }}</p>
                                <p><strong>Registered Agent:</strong> {{ business.registered_agent }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Service Breakdown -->
                    <div class="mb-4">
                        <h4>Service Breakdown</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for service in bundled_services %}
                                <tr>
                                    <td>{{ service.name }}</td>
                                    <td>${{ service.price }}</td>
                                </tr>
                                {% endfor %}
                                {% for request in individual_services %}
                                <tr>
                                    <td>{{ request.get_request_type_display }}</td>
                                    <td>${{ request.price }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                {% if show_discount %}
                                <tr>
                                    <th>Subtotal</th>
                                    <th>${{ subtotal }}</th>
                                </tr>
                                <tr class="table-success">
                                    <th>Compliance Bundle Discount</th>
                                    <th>-${{ discount }}</th>
                                </tr>
                                {% endif %}
                                <tr>
                                    <th>Total</th>
                                    <th>${{ total_price }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Agreement Section -->
                    <div class="mb-4">
                        <h4>Agreement and Signature</h4>
                        
                        <div class="mb-3">
                            <p class="small text-muted">
                                With my digital signature, (i) I represent and warrant that all of the information provided is accurate and complete; 
                                (ii) I agree that I have carefully read and agree to be bound by the Terms of Service, Refund Policy, and Privacy Policy (see below) 
                                and (iii) I have read and understand that I am hereby authorizing Business Compliance Organization NC as a "Third Party Designee" 
                                to process the requested services on my behalf using the information I provided.
                            </p>
                        </div>

                        <div class="mb-3">
                            <p class="small text-muted">
                                I agree to the terms & conditions and authorize this payment to Business Compliance Organization NC. 
                                I hereby certify that the information provided is correct and that I am authorized to conduct this transaction.
                            </p>
                        </div>

                        {% if has_labor_law_poster %}
                        <div class="mb-3">
                            <p class="small text-muted">
                                I understand that the labor law posters provided with this order will reflect the most current laws at the time of purchase 
                                and that this is a one-time transaction, not a subscription service. I acknowledge that I will not receive automatic updates 
                                regarding changes to the laws, and it is my sole responsibility to stay informed of any mandatory updates and ensure that 
                                the posters are updated as needed to maintain compliance.
                            </p>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <p class="small text-muted">
                                I have read, understand, and agree to be bound by the 
                                <a href="#" data-bs-toggle="modal" data-bs-target="#refundPolicyModal">Refund Policy</a>, 
                                <a href="#" data-bs-toggle="modal" data-bs-target="#privacyPolicyModal">Privacy Policy</a>, and 
                                <a href="#" data-bs-toggle="modal" data-bs-target="#termsOfServiceModal">Terms of Service</a>. 
                                I am aware that all payments are final, with the exceptions specified in the return policy.
                            </p>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <h4 class="card-title">Payment Method</h4>
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <form id="payment-form" method="post" class="needs-validation" novalidate>
                                        {% csrf_token %}
                                        <!-- Terms and Signature -->
                                        <div class="mb-4">
                                            <div class="form-check mb-3">
                                                <input type="checkbox" 
                                                       name="{{ form.agrees_to_terms_digital_signature.name }}"
                                                       id="{{ form.agrees_to_terms_digital_signature.id_for_label }}"
                                                       class="form-check-input"
                                                       required
                                                       {% if form.agrees_to_terms_digital_signature.value %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ form.agrees_to_terms_digital_signature.id_for_label }}">
                                                    I've read and accept the terms and conditions.
                                                </label>
                                                <div class="invalid-feedback">
                                                    You must agree to the terms and conditions.
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label for="{{ form.client_signature_text.id_for_label }}" class="form-label">Client Agreement & Signature</label>
                                                <input type="text" 
                                                       name="{{ form.client_signature_text.name }}"
                                                       id="{{ form.client_signature_text.id_for_label }}"
                                                       class="form-control"
                                                       value="{{ form.client_signature_text.value }}"
                                                       placeholder="Type your full name to sign"
                                                       required>
                                                <div class="invalid-feedback">
                                                    Please provide your signature.
                                                </div>
                                                <div class="form-text">
                                                    By typing your name above, you are digitally signing this application and affirming all statements and agreements.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Billing Information -->
                                        <div class="mb-4">
                                            <h5 class="card-subtitle mb-3">Billing Information</h5>
                                            
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label for="billing_address" class="form-label">Billing Address</label>
                                                    <input id="billing_address" 
                                                           name="billing_address" 
                                                           type="text" 
                                                           class="form-control" 
                                                           placeholder="Enter billing address"
                                                           required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="billing_zip" class="form-label">Billing ZIP Code</label>
                                                    <input id="billing_zip" 
                                                           name="billing_zip" 
                                                           type="tel" 
                                                           class="form-control" 
                                                           pattern="[0-9]{5}" 
                                                           maxlength="5"
                                                           placeholder="Enter ZIP code"
                                                           required>
                                                    <div class="invalid-feedback">
                                                        Please enter a valid 5-digit ZIP code.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Credit Card Information -->
                                        <div class="mb-4">
                                            <h5 class="card-subtitle mb-3">Credit Card Information</h5>
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <!-- Target for the credit card form -->
                                                    <div id="credit-card" class="mb-3"></div>
                                                    <div class="form-text text-muted">
                                                        <i class="bi bi-shield-lock me-1"></i>
                                                        Your payment information is secure and encrypted
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Hidden payment token field -->
                                        <input type="hidden" id="payment_token" name="payment_token">
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- GlobalPayments SDK -->
<script src="https://js.globalpay.com/v1/globalpayments.js"></script>
<script type="text/javascript">
    // Form validation function
    function validateForms() {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }

    // Call form validation
    validateForms();
    // Configure Heartland payment form styles
    const styles = {
        'input': {
            'font-size': '1rem',
            'font-weight': '400',
            'line-height': '1.5',
            'color': '#212529',
            'background-color': '#fff',
            'border': '1px solid #ced4da',
            'border-radius': '0.375rem',
            'padding': '0.375rem 0.75rem',
            'transition': 'border-color .15s ease-in-out,box-shadow .15s ease-in-out'
        },
        'input:focus': {
            'color': '#212529',
            'background-color': '#fff',
            'border-color': '#86b7fe',
            'outline': '0',
            'box-shadow': '0 0 0 0.25rem rgba(13,110,253,.25)'
        },
        'input.is-valid': {
            'border-color': '#198754',
            'padding-right': 'calc(1.5em + 0.75rem)',
            'background-image': 'url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 8 8\'%3e%3cpath fill=\'%23198754\' d=\'M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z\'/%3e%3c/svg%3e")',
            'background-repeat': 'no-repeat',
            'background-position': 'right calc(0.375em + 0.1875rem) center',
            'background-size': 'calc(0.75em + 0.375rem) calc(0.75em + 0.375rem)'
        },
        'input.is-invalid': {
            'border-color': '#dc3545',
            'padding-right': 'calc(1.5em + 0.75rem)',
            'background-image': 'url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 12 12\' width=\'12\' height=\'12\' fill=\'none\' stroke=\'%23dc3545\'%3e%3ccircle cx=\'6\' cy=\'6\' r=\'4.5\'/%3e%3cpath stroke-linejoin=\'round\' d=\'M5.8 3.6h.4L6 6.5z\'/%3e%3ccircle cx=\'6\' cy=\'8.2\' r=\'.6\' fill=\'%23dc3545\' stroke=\'none\'/%3e%3c/svg%3e")',
            'background-repeat': 'no-repeat',
            'background-position': 'right calc(0.375em + 0.1875rem) center',
            'background-size': 'calc(0.75em + 0.375rem) calc(0.75em + 0.375rem)'
        },
        'input::placeholder': {
            'color': '#6c757d',
            'opacity': '1'
        },
        'input:disabled': {
            'background-color': '#e9ecef',
            'opacity': '1'
        }
    };

    // Configure account
    GlobalPayments.configure({
        publicApiKey: "{{ heartland_public_key }}",
        styles: styles
    });

    // Create Form
    const cardForm = GlobalPayments.creditCard.form("#credit-card");

    // Handle successful tokenization
    cardForm.on("token-success", (resp) => {
        // Add payment token to form
        document.getElementById("payment_token").value = resp.paymentReference;
        
        // Submit the form
        document.getElementById("payment-form").submit();
    });

    // Handle tokenization errors
    cardForm.on("token-error", (resp) => {
        // Show error to the consumer
        const errorDiv = document.createElement("div");
        errorDiv.className = "alert alert-danger mt-3";
        errorDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${resp.error.message}`;
        document.getElementById("credit-card").appendChild(errorDiv);
    });

    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener("submit", function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    })();
</script>
{% endblock %} 